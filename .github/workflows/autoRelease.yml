name: Release

on:
  push:
    branches:
      - main

jobs:

  release:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
        
    - name: Use Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14'
        
    - name: Install dependencies
      run: npm ci
        
    - name: Build project
      run: npm run build
        
    - name: Bump version and create release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        version=$(node -p "require('./package.json').version")
        
        new_version=$(node -e "console.log('$version'.split('.').map((v,i) => i===2?parseInt(v)+0.1:parseInt(v)).join('.'))")
        
        npm version $new_version -m "Bump version to %s"
        
        gh release create v$new_version --generate-notes
